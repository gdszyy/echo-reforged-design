# “机制原子”引擎设计文档

> **文档版本**: 1.1
> **最后更新**: 2026-01-07

## 概述

本系统是“子弹编程”的核心，一个基于“机制原子”的涌现式规则引擎。它旨在提供一套纯粹、高度模块化且充满涌现性的底层创作工具，让玩家可以通过组合最基础的“原子”，来“涌现”出无穷无尽、逻辑自洽的复杂游戏机制。

### 设计哲学

1.  **纯粹性**：严格遵守单一职责原则。子弹编程系统只负责“动作执行”，不负责“逻辑判断”。它只发布事件，由其他独立系统（如温度系统、状态系统）监听并响应。
2.  **涌现性**：复杂的游戏机制不是被“设计”出来的，而是从基础原子的交互中自然“涌现”出来的。
3.  **与核心玩法深度绑定**：规则的构建与钉盘系统完全整合。每一个钉子都是一条“规则”的物理载体，弹珠的弹射轨迹即是“编程”的过程。

---

## 一、 属性分层

| 层级 | 描述 | 示例 | 是否参与Cost计算 |
| :--- | :--- | :--- | :--- |
| **基础属性** | 子弹/弹珠的固有物理特性 | 穿透、反弹、散射、速度、大小 | **否** |
| **规则属性** | 由钉子赋予的行为规则 | 造成伤害、修改温度、生成子弹 | **是** |

---

## 二、 “机制原子”库

#### 【触发器】(Trigger) - 定义“何时”发生

| 触发器 | Cost | 备注 |
| :--- | :--- | :--- |
| `OnCollision` | 0 | 每次碰撞时。 |
| `OnFirstCollision` | 0 | 仅在第一次碰撞时。 |
| `OnPenetrate` | 0 | 每次穿透时。 |
| `OnDeath` | 0 | 生命周期结束时。 |
| `OnKill` | 1 | 击杀敌人时。 |
| `OnTimer` | 2 | 每隔N秒。 |
| `OnAttachedTargetHit` | 1 | 附着的目标被攻击时。 |

#### 【效果】(Effect) - 定义“做什么”

| 效果 | Cost | 备注 |
| :--- | :--- | :--- |
| `DealDamage(N)` | N/10 | 造成N点伤害。 |
| `ModifyTemperature(±N)` | N | 修改N度温度。 |
| `ApplyTag` | 1 | 施加标签。 |
| `ApplyForce` | 1 | 施加力。 |
| `Attach` / `Detach` | 2 / 0 | 附着/脱离。 |
| `Return` | 1 | 返回。 |
| `Spawn(Type, N)` | 3 + N×子弹Cost | 生成N个指定类型的实体。 |

#### 可`Spawn`的实体类型 (Type)

| 类型 | 描述 | 持续消耗 |
| :--- | :--- | :--- |
| `Bullet` | 普通子弹/弹珠。 | 否 |
| `Explosion` | 范围伤害实体。 | 否 |
| `Slash` | 范围斩击实体。 | 否 |
| `ChainLightning` | 闪电链实体。 | 是 |
| `Laser` | 激光束实体。 | 是 |

**持续消耗 (Upkeep)**：所有被召唤出的、且需要持续存在的实体（如闪电链、激光），在其存在期间，会**持续消耗玩家的法力值**。

#### 【目标】(Target) - 定义对“谁”生效

| 目标 | Cost 倍率 |
| :--- | :--- |
| `Self` | ×0.5 |
| `CollisionTarget` | ×1.0 |
| `NearestEnemy` | ×1.2 |
| `EnemiesInRadius(R)` | ×(1 + R×0.2) |
| `Owner` | ×0.5 |

#### 【修饰器】(Modifier) - 定义“怎么样”

| 修饰器 | Cost 调整 |
| :--- | :--- |
| `Chance(P%)` | ×(P/100) |

#### 【负面效果】(Debuff) - 用于Cost减免

| 负面效果 | Cost 减免 |
| :--- | :--- |
| `SelfDamage(N)` | -N/10 |
| `SlowProjectile` | -1 |
| `ReducedLifetime` | -1 |
| `Inaccuracy` | -2 |
| `ExtraShot(+1)` | 强制Cost+5 |

---

## 三、 激光 (Laser) 的整合

激光是 `Spawn` 效果可以创造的一种实体类型。它与基础属性的交互方式特殊：

- **穿透 (Penetrate)**：定义**激光的长度**。
- **反弹 (Bounce)**：激光束在遇到墙壁时，会进行**反射**。
- **散射 (Scatter)**：在激光的终点或碰撞点，**分裂**出多条新的激光束。

---

## 四、 Cost 计算与继承

### 4.1 钉盘叠加

- **核心**：每一个钉子都是一条“规则”的物理载体。弹珠的最终 Cost = 所有经过的钉子的 Cost 之和。
- **上限**：发射器有一个 Cost 上限，弹珠最终 Cost 超过上限则无法发射。

### 4.2 套娃（Inherit）的 Cost 计算

当使用 `Spawn` 效果且规则链为 `INHERIT` 时：

- **Spawn 的 Cost = 3 + N × 被继承子弹的基础Cost**
- **被继承子弹的基础Cost**：只计算子弹自身的规则Cost，**不包含**：
  - 父弹的 `Spawn` 效果Cost（避免无限递归）。
  - 连射次数（`ExtraShot` 不继承）。

---

## 五、 示例：用“原子”重构世界

### 5.1 基础属性复刻

| 属性 | 规则链 | Cost |
| :--- | :--- | :--- |
| **火** | `OnCollision` -> `ModifyTemperature(+50)` | 50 |
| **冰** | `OnCollision` -> `ModifyTemperature(-50)` | 50 |
| **伤害** | `OnCollision` -> `DealDamage(100)` | 10 |
| **闪电链(50%)** | `OnCollision` -> `Spawn(ChainLightning, 1)` x `Chance(50%)` | 3 x 0.5 = 1.5 ≈ 2 |
| **套娃** | `OnDeath` -> `Spawn(Bullet, 3, INHERIT)` | 3 + 3 x (子弹Cost) |

### 5.2 中等复杂度示例

| 名称 | 效果描述 | 规则链 | 预估Cost |
| :--- | :--- | :--- | :--- |
| **冰霜炸弹** | 子弹在消失时产生一次冰霜爆炸，对范围内的敌人造成少量伤害并大幅降温。 | `OnDeath` -> `Spawn(Explosion, 1)`<br>爆炸实体规则: `OnSpawn` -> `DealDamage(30)` + `ModifyTemperature(-80)` | 0 + (3 + 3 + 80) = 86 |
| **追踪火球** | 子弹在第一次碰撞后，会转向并追踪最近的敌人。 | `OnFirstCollision` -> `Movement: Homing(NearestEnemy)` | 0 + 0 = 0 (寻的是运动模式，不算效果) |
| **吸血鬼之触** | 子弹每次造成伤害时，有25%的概率为玩家恢复等同于伤害值10%的生命。 | `OnDealDamage` -> `ModifyValue(Owner, health, +Damage*0.1)` x `Chance(25%)` | (0 + 1 x 0.5) x 0.25 ≈ 1 |

### 5.3 高复杂度示例

| 名称 | 效果描述 | 规则链 | 预估Cost |
| :--- | :--- | :--- | :--- |
| **连锁过载反应** | 子弹在击杀敌人时，会以其为中心召唤一道闪电链；同时，如果击杀的是被“标记”的敌人，则额外生成一个爆炸。 | 1. `OnKill` -> `Spawn(ChainLightning, 1)`<br>2. `OnKill` -> `IF(Target.HasTag(Marked))` -> `Spawn(Explosion, 1)` | (1 + 3) + (1 + 3) = 8 |
| **黑洞奇点** | 子弹在消失时，在原地创建一个持续3秒的引力场，每秒对范围内的所有敌人施加一次强大的向心力，并造成少量伤害。 | 1. `OnDeath` -> `Spawn(Singularity, 1)`<br>2. **奇点实体规则**: `OnTimer(1s)` -> `ForAll(EnemiesInRadius)` -> `ApplyForce(向心力)` + `DealDamage(10)`<br>3. **奇点实体规则**: `OnTimer(3s)` -> `Die` | 0 + (3 + 2 + (1+1)x(1+R*0.2)) = 5 + 2.4 = 7.4 ≈ 8 |
| **反弹激光矩阵** | 发射一束可以反弹3次的激光。每次反弹时，激光都会分裂成两束新的、长度减半的激光。 | 1. **激光基础属性**: 反弹3, 穿透10<br>2. **激光规则**: `OnCollision(Wall)` -> `Spawn(Laser, 2, INHERIT)` x `Modifier(穿透x0.5)` | 0 + (3 + 2x(子激光Cost)) ≈ 9+ |

---

## 六、 记录、存储与编辑

### 6.1 记录方式 (JSON)

所有“子弹程序”都以JSON格式进行结构化记录，清晰地表达规则链的嵌套关系。

### 6.2 存储方式 (炼金刻录)

玩家在“炼金台”上，将设计好的“子弹程序”刻录到“空白符文石”中，生成可装备的“成品符文石”。此过程与游戏资源循环深度绑定。

### 6.3 编辑方式 (节点式编辑器)

提供可视化的“规则编织器”界面，玩家通过拖拽和连接节点来“编程”，极大地降低了创造门槛，同时保留了无穷的组合深度。
